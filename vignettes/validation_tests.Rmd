---
title: "R Notebook"
output: html_notebook
author: "Wade Dismukes"
---
```{r setup, include=FALSE}
library(treeduckenValidation)
library(ggplot2)
library(khroma)
```
The following are validation tests of the `treeducken` package with accompanying figures.



## Testing species tree simulation 

### GSA tests

```{r}
# first decide on parameters
sbr <- seq(from= 1, to = 6)
sdr <- sbr / 4
num_tips <- 50
reps <- 1000
# run the main function
gsa_spt_nds <- treeduckenValidation::gsa_test_data_generation(sbr,
                                                               sdr,
                                                               num_tips,
                                                               reps = reps)


plot_df <- format_gsa_test_df(gsa_spt_nds, sbr)

ggplot2::ggplot(data = plot_df, 
                ggplot2::aes(x = key, y = value, fill = simulator)) + 
    ggplot2::geom_boxplot() +
    ggplot2::theme_bw() +
    khroma::scale_fill_bright() +
    ggplot2::xlab("Speciation rate") + 
    ggplot2::ylab("Tree depth")
    
```

### SSA tests

```{r}
sim_time <- 1.0

ssa_spt_tips <- ssa_test_data_generation(sbr,
                                        sdr,
                                        time = sim_time,
                                        reps = reps)


ssa_tidy_df <- format_ssa_test(ssa_spt_tips, sbr)

ssa_exp_tidy_df <- get_ssa_expected_values(sbr,
                                       sdr,
                                       sim_time,
                                       ssa_tidy_df)



ggplot2::ggplot(data = ssa_tidy_df, 
                ggplot2::aes(x = key, y = value)) + 
    ggplot2::geom_boxplot() +
    ggplot2::geom_point(data = ssa_exp_tidy_df,
                ggplot2::aes(x = key,
                            y = value,
                            col = "red",
                            size = 0.5)) + 
    ggplot2::theme_bw() +
    khroma::scale_fill_bright() +
    ggplot2::xlab("Speciation rate") + 
    ggplot2::ylab("Number of leaves") + 
    guides(col=FALSE, size=FALSE)
    
    
```


## Testing Locus tree simulation

```{r}
num_tips <- 20
gbr <- seq(from = 1, to = 10) / 5
gdr <- gbr / 4
loctr_tips <- locus_tree_test(gbr, gdr, num_tips, reps)

loctr_tips_tidy_df <- format_loctree_test(loctr_tips, gbr)
loct_expected_tidy_df <- get_loctr_expected_values(gbr,
                                                   gdr,
                                                   num_tips,
                                                   loctr_tips,
                                                   loctr_tips_tidy_df)

ggplot2::ggplot(data = loctr_tips_tidy_df, 
                ggplot2::aes(x = key, y = value)) + 
    ggplot2::geom_boxplot() +
    ggplot2::geom_point(data = loct_expected_tidy_df,
                ggplot2::aes(x = key,
                            y = value,
                            col = "red",
                            size = 0.5)) + 
    ggplot2::theme_bw() +
    khroma::scale_fill_bright() +
    ggplot2::xlab("Gene Birte Rate") + 
    ggplot2::ylab("Number of leaves") + 
    guides(col=FALSE, size = FALSE)
    
# make into dataframe
# name columns
# plot
```

## Testing Gene tree simulation

### Multi-species coalescent
```{r}
gt_reps <- reps
test_reps <- 10
tips <- rep(25, times = test_reps)

theta <- rlnorm(n = test_reps, meanlog = 1.4, sdlog = 0.004)

gt_tmrcas <- gene_tree_msc_test(theta, tips, gt_reps = gt_reps, test_reps = test_reps)

gt_tidy_df <- format_gene_tree_df(gt_tmrcas, theta)
# expected tmrca (might nee other stuff?)
ggplot2::ggplot(data = gt_tidy_df, 
                ggplot2::aes(x = key, y = value)) + 
    ggplot2::geom_boxplot() +
    ggplot2::theme_bw() +
    khroma::scale_fill_bright() +
    ggplot2::xlab("Population size") + 
    ggplot2::ylab("Time to most recent common ancestor") + 
    guides(col=FALSE, size = FALSE) + 
    theme(axis.text.x = element_text(angle = 90, hjust = 1))

```

### Multi-locus coalescent


## Testing cophylogenetic simulation


### Host tree tests

```{r}
lambda_h <- seq(from = 1, to = 10) / 10
lambda_c <- 1.0
mu_h <- (lambda_h + lambda_c) / 2

ht_test_tips <- host_tree_test(hbr = lambda_h,
                                hdr = mu_h,
                                cosp_rate = lambda_c,
                                reps = reps,
                                time = sim_time)


ht_test_tidy_df <- format_host_test_data(ht_test_tips, lambda_h)


ht_expected_tips_tidy_df <- get_host_expected_values(lambda_h,
                                     lambda_c,
                                     mu_h,
                                     sim_time,
                                     ht_test_tidy_df)

library(ggplot2)
library(khroma)
ggplot2::ggplot(data = ht_test_tidy_df, 
                ggplot2::aes(x = key, y = value)) + 
    ggplot2::geom_boxplot() +
    ggplot2::geom_point(data = ht_expected_tips_tidy_df,
                ggplot2::aes(x = key,
                            y = value,
                            col = "red",
                            size = 0.5)) + 
    ggplot2::theme_bw() +
    khroma::scale_fill_bright() +
    ggplot2::xlab("Host speciation rate") + 
    ggplot2::ylab("Number of leaves") + 
    guides(col=FALSE, size=FALSE)
    
    
```

### Symbiont tree tests


```{r}
lambda_c <- 0.5
lambda_s <- seq(from = 1, to = 3) / 1.0
mu_s <- lambda_s / 4
symbt_test_tips <- symb_tree_test(cosp_rate = lambda_c,
                                  sbr = lambda_s,
                                  sdr = mu_s,
                                  reps = reps,
                                  time = sim_time)

symbt_expected_tips <- matrix(nrow = reps, ncol = length(lambda_s))
for(i in seq_len(length(lambda_s))) {
    for(j in 1:reps) {
        symbt_expected_tips[j, i] <- treeducken::calculate_expected_leaves_locustree(
                                            t = sim_time,
                                            dup_rate = lambda_s[i],
                                            loss_rate = mu_s[i],
                                            num_species = symbt_test_tips[j, i + length(lambda_s)])
        if(is.infinite(symbt_expected_tips[j, i]))
            symbt_expected_tips[j, i] <- NA
    }
}



symbt_test_tips_df <- as.data.frame(symbt_test_tips[,1:length(lambda_s)])
symbt_column_namer <- function(lambda_s) {
    paste("lambda_s=", lambda_s)
}
colnames(symbt_test_tips_df) <- symbt_column_namer(lambda_s)
symbt_test_tips_tidy_df <- tidyr::gather(symbt_test_tips_df)
symbt_test_tips_tidy_df$type <- rep("observed", times = nrow(symbt_test_tips_tidy_df))

symbt_expected_tips_df <- as.data.frame(symbt_expected_tips)
colnames(symbt_expected_tips_df) <- colnames(symbt_test_tips_df)
symbt_expected_tips_df <- tidyr::gather(symbt_expected_tips_df)
symbt_expected_tips_df$type <- rep("expected", times = nrow(symbt_expected_tips_df))
symbt_plot_df <- rbind(symbt_test_tips_tidy_df, symbt_expected_tips_df)

library(ggplot2)
library(khroma)
ggplot2::ggplot(data = symbt_plot_df, 
                ggplot2::aes(x = key, y = value, fill = type)) + 
    ggplot2::geom_boxplot() +
    ggplot2::theme_bw() +
    khroma::scale_fill_bright() +
    ggplot2::xlab("Symbiont speciation rate") + 
    ggplot2::ylab("Number of leaves")
```
